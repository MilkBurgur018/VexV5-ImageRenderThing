<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEX V5 Pixel Art Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #0f0f0f; 
            color: #e0e0e0; 
            overflow: hidden; 
            touch-action: none;
        }
        
        #canvas-viewport {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #121212;
            background-image: radial-gradient(#2a2a2a 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: none;
        }

        canvas { 
            image-rendering: pixelated; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background-color: #000;
            transform-origin: center center;
        }

        .tool-btn {
            @apply p-2 rounded transition-all duration-200 border border-transparent text-gray-400;
        }
        .tool-btn.active { 
            background-color: white; 
            color: black; 
            border-color: #ccc; 
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .color-swatch { 
            width: 28px; height: 28px; 
            border: 2px solid #333; 
            border-radius: 6px; 
            cursor: pointer;
            transition: transform 0.1s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: #fff; box-shadow: 0 0 8px #fff; transform: scale(1.15); z-index: 10; }
        
        #colorPickerInput {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            cursor: pointer;
            background: none;
        }
        #colorPickerInput::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPickerInput::-webkit-color-swatch { border: 2px solid #555; border-radius: 6px; }

        #brush-cursor {
            position: fixed;
            pointer-events: none;
            border-radius: 50%;
            background-color: white;
            mix-blend-mode: difference;
            z-index: 100;
            transform: translate(-50%, -50%);
            display: none;
        }

        /* IDE Syntax Highlighting */
        .code-keyword { color: #c678dd; font-weight: bold; } 
        .code-func { color: #61afef; }   
        .code-string { color: #98c379; } 
        .code-comment { color: #5c6370; font-style: italic; }
        .code-type { color: #e5c07b; }   
        .code-number { color: #d19a66; }

        .code-block-container {
            background-color: #1a1b1c;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            overflow-x: auto;
            user-select: text !important;
            cursor: text;
        }
        pre, code { user-select: text !important; white-space: pre; }

        .lang-btn {
            @apply px-6 py-2 rounded-lg text-sm font-bold transition-all border border-gray-700 text-gray-400;
        }
        .lang-btn.active {
            @apply bg-blue-600 text-white border-blue-500 shadow-lg scale-105;
        }

        .kbd-key {
            @apply bg-gray-800 border-b-2 border-gray-950 px-1.5 py-0.5 rounded text-[10px] text-gray-300 font-mono;
        }

        #exportResult {
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="flex flex-col h-screen w-screen select-none">

    <div id="brush-cursor"></div>

    <!-- Help & Code Modal -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-[#121212] rounded-2xl max-w-5xl w-full max-h-[90vh] flex flex-col shadow-2xl border border-gray-800">
            <div class="flex justify-between items-center p-5 border-b border-gray-800">
                <h2 class="text-xl font-bold text-white flex items-center gap-3">
                    <i data-lucide="terminal" class="w-6 h-6 text-blue-500"></i> Tips and Info
                </h2>
                <button onclick="toggleHelp()" class="text-gray-400 hover:text-white hover:bg-gray-800 p-2 rounded-full transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-8">
                <!-- Guide Section -->
                <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                        <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="keyboard" class="w-3 h-3"></i> Tool Hotkeys
                        </h3>
                        <div class="grid grid-cols-2 gap-y-3 text-sm">
                            <div class="flex items-center gap-2 text-gray-400"><span class="kbd-key">1</span> Brush</div>
                            <div class="flex items-center gap-2 text-gray-400"><span class="kbd-key">2</span> Line</div>
                            <div class="flex items-center gap-2 text-gray-400"><span class="kbd-key">3</span> Bucket</div>
                            <div class="flex items-center gap-2 text-gray-400"><span class="kbd-key">4 / Middle Click</span> Pan View</div>
                            <div class="flex items-center gap-2 text-gray-400"><span class="kbd-key">Ctrl+Z</span> Undo</div>
                            <div class="flex items-center gap-2 text-gray-400"><span class="kbd-key">Ctrl+Y</span> Redo</div>
                        </div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                        <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="image" class="w-3 h-3"></i> Tips
                        </h3>
                        <div class="text-sm text-gray-400 leading-relaxed">
                            Use <b>Import</b> to convert any photo into a 480x240 VEX-ready image. Adjust <b>Compression Slider</b> in Export to save memory.
                        </div>
                    </div>
                </section>

                <hr class="border-gray-800">

                <div class="flex justify-center gap-4">
                    <button onclick="setLang('cpp')" id="btn-cpp" class="lang-btn active">C++ (Competition)</button>
                </div>

                <div class="relative">
                    <!-- C++ CODE (FULLY FIXED FOR COMP TEMPLATE) -->
                    <div id="cont-cpp" class="lang-content">
                        <div class="code-block-container">
<pre><code><span class="code-comment">/*----------------------------------------------------------------------------*/
/* */
/* Module:       main.cpp                                                  */
/* Description:  VEX V5 Pixel Art Renderer (Competition Format)            */
/* */
/*----------------------------------------------------------------------------*/

// ---- VEXCODE GENERATED CONFIGURATION (DO NOT EDIT) ----
#pragma region VEXcode Generated Robot Configuration</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;stdio.h&gt;</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;stdlib.h&gt;</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;stdbool.h&gt;</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;math.h&gt;</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;string.h&gt;</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;vector&gt;</span>
<span class="code-keyword">#include</span> <span class="code-string">&lt;string&gt;</span>

<span class="code-keyword">#include</span> <span class="code-string">"vex.h"</span>

<span class="code-keyword">using namespace</span> <span class="code-type">vex</span>;

<span class="code-type">brain</span> Brain;

<span class="code-comment">// START V5 MACROS</span>
<span class="code-keyword">#define</span> waitUntil(condition) \
  <span class="code-keyword">do</span> { \
    <span class="code-func">wait</span>(<span class="code-number">5</span>, msec); \
  } <span class="code-keyword">while</span> (!(condition))

<span class="code-keyword">#define</span> repeat(iterations) \
  <span class="code-keyword">for</span> (<span class="code-keyword">int</span> iterator = <span class="code-number">0</span>; iterator &lt; iterations; iterator++)
<span class="code-comment">// END V5 MACROS</span>

<span class="code-keyword">void</span> <span class="code-func">initializeRandomSeed</span>(){
  <span class="code-keyword">int</span> systemTime = Brain.Timer.systemHighResolution();
  <span class="code-keyword">double</span> batteryCurrent = Brain.Battery.current();
  <span class="code-keyword">double</span> batteryVoltage = Brain.Battery.voltage(voltageUnits::mV);
  <span class="code-keyword">int</span> seed = <span class="code-keyword">int</span>(batteryVoltage + batteryCurrent * <span class="code-number">100</span>) + systemTime;
  <span class="code-func">srand</span>(seed);
}

<span class="code-keyword">void</span> <span class="code-func">vexcodeInit</span>() {
  <span class="code-func">initializeRandomSeed</span>(); 
}
<span class="code-comment">#pragma endregion VEXcode Generated Robot Configuration</span>
<span class="code-comment">// ---- END CONFIGURATION ----</span>


<span class="code-keyword">#include</span> <span class="code-string">"vex.h"</span>
<span class="code-keyword">using namespace</span> <span class="code-type">vex</span>;

<span class="code-comment">// -----------------------------------------------------------
// PASTE YOUR PIXEL STUDIO EXPORT STRING BELOW
// -----------------------------------------------------------</span>
<span class="code-keyword">const char*</span> <span class="code-type">IMG_DATA</span> = <span class="code-string">"PASTE_STRING_HERE"</span>;
<span class="code-comment">// -----------------------------------------------------------</span>

<span class="code-comment">// Manual Base36 Parser (Fixes 'stoi' not found error)</span>
<span class="code-keyword">int</span> <span class="code-func">b36ToInt</span>(<span class="code-type">std::string</span> s) {
    <span class="code-keyword">int</span> res = <span class="code-number">0</span>;
    <span class="code-keyword">for</span>(<span class="code-keyword">char</span> c : s) {
        res *= <span class="code-number">36</span>;
        <span class="code-keyword">if</span> (c >= <span class="code-string">'0'</span> && c &lt;= <span class="code-string">'9'</span>) res += (c - <span class="code-string">'0'</span>);
        <span class="code-keyword">else if</span> (c >= <span class="code-string">'a'</span> && c &lt;= <span class="code-string">'z'</span>) res += (<span class="code-number">10</span> + (c - <span class="code-string">'a'</span>));
    }
    <span class="code-keyword">return</span> res;
}

<span class="code-keyword">long</span> <span class="code-func">parseIntCustom</span>(<span class="code-keyword">const char*</span>& ptr, <span class="code-keyword">char</span> d) {
    <span class="code-keyword">long</span> v = <span class="code-number">0</span>;
    <span class="code-keyword">while</span> (*ptr && *ptr != d && *ptr != <span class="code-string">' '</span> && *ptr != <span class="code-string">'|'</span> && *ptr != <span class="code-string">';'</span>) {
        v = v * <span class="code-number">10</span> + (*ptr - <span class="code-string">'0'</span>); ptr++;
    }
    <span class="code-keyword">if</span> (*ptr == d) ptr++;
    <span class="code-keyword">return</span> v;
}

<span class="code-keyword">void</span> <span class="code-func">drawArt</span>(<span class="code-keyword">const char*</span> data) {
    Brain.Screen.clearScreen();
    <span class="code-keyword">const char*</span> ptr = data;
    <span class="code-keyword">int</span> step = <span class="code-func">parseIntCustom</span>(ptr, <span class="code-string">'|'</span>);
    
    <span class="code-type">std::vector</span>&lt;<span class="code-keyword">uint32_t</span>&gt; pal;
    <span class="code-keyword">while</span>(*ptr && *ptr != <span class="code-string">'|'</span>) {
        <span class="code-keyword">char</span> hex[<span class="code-number">7</span>]; <span class="code-keyword">int</span> h = <span class="code-number">0</span>;
        <span class="code-keyword">while</span>(*ptr && *ptr != <span class="code-string">','</span> && *ptr != <span class="code-string">'|'</span> && *ptr != <span class="code-string">' '</span>) {
            <span class="code-keyword">if</span>(h &lt; <span class="code-number">6</span>) hex[h++] = *ptr; ptr++;
        }
        hex[h] = <span class="code-string">'\0'</span>;
        pal.<span class="code-func">push_back</span>((<span class="code-keyword">uint32_t</span>)<span class="code-func">strtol</span>(hex, <span class="code-keyword">NULL</span>, <span class="code-number">16</span>));
        <span class="code-keyword">if</span>(*ptr == <span class="code-string">','</span> || *ptr == <span class="code-string">' '</span>) ptr++;
    }
    <span class="code-keyword">if</span>(*ptr == <span class="code-string">'|'</span>) ptr++;
    
    <span class="code-keyword">int</span> x = <span class="code-number">0</span>, y = <span class="code-number">0</span>;
    <span class="code-keyword">while</span>(*ptr) {
        <span class="code-keyword">if</span>(*ptr == <span class="code-string">';'</span>) { x = <span class="code-number">0</span>; y += step; ptr++; <span class="code-keyword">continue</span>; }
        
        <span class="code-type">std::string</span> iS = <span class="code-string">""</span>, lS = <span class="code-string">""</span>;
        <span class="code-keyword">while</span>(*ptr && *ptr != <span class="code-string">'.'</span>) iS += *ptr++; <span class="code-keyword">if</span>(*ptr == <span class="code-string">'.'</span>) ptr++;
        <span class="code-keyword">while</span>(*ptr && *ptr != <span class="code-string">','</span> && *ptr != <span class="code-string">';'</span>) lS += *ptr++; <span class="code-keyword">if</span>(*ptr == <span class="code-string">','</span>) ptr++;
        
        <span class="code-keyword">int</span> cIdx = <span class="code-func">b36ToInt</span>(iS), run = <span class="code-func">b36ToInt</span>(lS);
        
        <span class="code-keyword">if</span>(cIdx &lt; pal.<span class="code-func">size</span>()) {
            Brain.Screen.setFillColor(vex::color(pal[cIdx]));
            Brain.Screen.setPenColor(vex::color(pal[cIdx]));
            <span class="code-keyword">for</span>(<span class="code-keyword">int</span> k=<span class="code-number">0</span>; k&lt;run; k++) {
                <span class="code-keyword">if</span>(y &gt;= <span class="code-number">240</span>) <span class="code-keyword">return</span>;
                Brain.Screen.drawRectangle(x, y, step, step); x += step;
            }
        }
    }
}

<span class="code-keyword">void</span> <span class="code-func">preAutonomous</span>(<span class="code-keyword">void</span>) {
  <span class="code-comment">// Draw the image when the program starts</span>
  <span class="code-func">drawArt</span>(<span class="code-type">IMG_DATA</span>);
}

<span class="code-keyword">void</span> <span class="code-func">autonomous</span>(<span class="code-keyword">void</span>) {
  <span class="code-comment">// Autonomous code here</span>
}

<span class="code-keyword">void</span> <span class="code-func">userControl</span>(<span class="code-keyword">void</span>) {
  <span class="code-keyword">while</span> (<span class="code-number">true</span>) {
    <span class="code-func">wait</span>(<span class="code-number">20</span>, msec);
  }
}

<span class="code-keyword">int</span> <span class="code-func">main</span>() {
  <span class="code-comment">// Initializing Robot Configuration. DO NOT REMOVE!</span>
  <span class="code-func">vexcodeInit</span>();
  
  <span class="code-type">competition</span> Competition;
  Competition.<span class="code-func">autonomous</span>(autonomous);
  Competition.<span class="code-func">drivercontrol</span>(userControl);

  <span class="code-func">preAutonomous</span>();

  <span class="code-keyword">while</span> (<span class="code-number">true</span>) {
    <span class="code-func">wait</span>(<span class="code-number">100</span>, msec);
  }
}</code></pre>
                        </div>
                    </div>
                    <!-- PYTHON CODE -->
                    <div id="cont-py" class="lang-content hidden">
                        <div class="code-block-container">
<pre><code><span class="code-comment"># Paste into VEX Python Project</span>
<span class="code-type">IMG_DATA</span> = <span class="code-string">"PASTE_STRING_HERE"</span>

<span class="code-keyword">def</span> <span class="code-func">draw_art</span>(<span class="code-type">data</span>):
    <span class="code-type">parts</span> = <span class="code-type">data</span>.<span class="code-func">split</span>(<span class="code-string">'|'</span>)
    <span class="code-type">step</span> = <span class="code-builtin">int</span>(<span class="code-type">parts</span>[<span class="code-number">0</span>])
    <span class="code-type">pal_strs</span> = <span class="code-type">parts</span>[<span class="code-number">1</span>].<span class="code-func">split</span>(<span class="code-string">','</span>)
    <span class="code-type">palette</span> = []
    
    <span class="code-keyword">for</span> <span class="code-type">h</span> <span class="code-keyword">in</span> <span class="code-type">pal_strs</span>:
        <span class="code-keyword">if</span> <span class="code-type">h</span>.<span class="code-func">strip</span>():
            <span class="code-type">v</span> = <span class="code-builtin">int</span>(<span class="code-type">h</span>.<span class="code-func">strip</span>(), <span class="code-number">16</span>)
            <span class="code-type">palette</span>.<span class="code-func">append</span>(<span class="code-type">Color</span>((<span class="code-type">v</span>>><span class="code-number">16</span>)&<span class="code-number">255</span>, (<span class="code-type">v</span>>><span class="code-number">8</span>)&<span class="code-number">255</span>, <span class="code-type">v</span>&<span class="code-number">255</span>))
            
    <span class="code-type">y</span> = <span class="code-number">0</span>
    <span class="code-type">rows</span> = <span class="code-type">parts</span>[<span class="code-number">2</span>].<span class="code-func">split</span>(<span class="code-string">';'</span>)
    
    <span class="code-keyword">for</span> <span class="code-type">row</span> <span class="code-keyword">in</span> <span class="code-type">rows</span>:
        <span class="code-type">x</span> = <span class="code-number">0</span> 
        <span class="code-type">items</span> = <span class="code-type">row</span>.<span class="code-func">split</span>(<span class="code-string">','</span>)
        <span class="code-keyword">for</span> <span class="code-type">item</span> <span class="code-keyword">in</span> <span class="code-type">items</span>:
            <span class="code-keyword">if</span> <span class="code-string">'.'</span> <span class="code-keyword">not in</span> <span class="code-type">item</span>: <span class="code-keyword">continue</span>
            <span class="code-type">p</span> = <span class="code-type">item</span>.<span class="code-func">split</span>(<span class="code-string">'.'</span>)
            <span class="code-type">idx</span> = <span class="code-builtin">int</span>(<span class="code-type">p</span>[<span class="code-number">0</span>], <span class="code-number">36</span>)
            <span class="code-type">count</span> = <span class="code-builtin">int</span>(<span class="code-type">p</span>[<span class="code-number">1</span>], <span class="code-number">36</span>)
            
            <span class="code-keyword">if</span> <span class="code-type">idx</span> < <span class="code-builtin">len</span>(<span class="code-type">palette</span>):
                <span class="code-type">c</span> = <span class="code-type">palette</span>[<span class="code-type">idx</span>]
                <span class="code-type">brain</span>.screen.<span class="code-func">set_pen_color</span>(<span class="code-type">c</span>)
                <span class="code-type">brain</span>.screen.<span class="code-func">set_fill_color</span>(<span class="code-type">c</span>)
                <span class="code-keyword">for</span> <span class="code-type">_</span> <span class="code-keyword">in</span> <span class="code-builtin">range</span>(<span class="code-type">count</span>):
                    <span class="code-type">brain</span>.screen.<span class="code-func">draw_rectangle</span>(<span class="code-type">x</span>, <span class="code-type">y</span>, <span class="code-type">step</span>, <span class="code-type">step</span>)
                    <span class="code-type">x</span> += <span class="code-type">step</span>
        <span class="code-type">y</span> += <span class="code-type">step</span></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-900 border-t border-gray-800 rounded-b-2xl flex justify-end">
                <button onclick="toggleHelp()" class="bg-gray-800 hover:bg-gray-700 text-white px-8 py-2.5 rounded-xl font-bold transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#121212] rounded-2xl max-w-2xl w-full flex flex-col shadow-2xl border border-gray-800">
            <div class="flex justify-between items-center p-5 border-b border-gray-800">
                <h2 class="text-xl font-bold text-white flex items-center gap-3">
                    <i data-lucide="zap" class="w-6 h-6 text-yellow-500"></i> Export & Compress
                </h2>
                <button onclick="toggleExportModal()" class="text-gray-400 hover:text-white p-2 rounded-full transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Sliders -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-gray-300">Pixelation (Step)</label>
                            <span id="stepVal" class="text-xs font-mono text-blue-400">1x</span>
                        </div>
                        <input type="range" id="stepRange" min="1" max="10" value="1" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                               oninput="updateExportPreview()">
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-gray-300">Similarity Blend</label>
                            <span id="blendVal" class="text-xs font-mono text-green-400">0%</span>
                        </div>
                        <input type="range" id="blendRange" min="0" max="100" value="0" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500"
                               oninput="updateExportPreview()">
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="flex gap-4 h-40">
                    <div class="flex-1 flex flex-col">
                        <p class="text-xs text-gray-400 mb-1">Preview:</p>
                        <div class="border border-gray-700 rounded-lg overflow-hidden bg-black flex justify-center items-center flex-1">
                            <canvas id="previewCanvas" width="480" height="240" class="max-w-full max-h-full object-contain"></canvas>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <div class="flex justify-between items-end mb-1">
                            <p class="text-sm text-gray-400">Compressed Data:</p>
                            <span id="charCount" class="text-[10px] font-mono text-gray-500 uppercase">0 Chars</span>
                        </div>
                        <!-- Memory Warning -->
                        <div id="memoryWarning" class="hidden text-[10px] text-red-200 bg-red-900/40 border border-red-900 p-2 rounded mb-2 flex items-start gap-2">
                            <i data-lucide="alert-triangle" class="w-3 h-3 mt-0.5 shrink-0"></i>
                            <span>Warning: String > 50KB. Increase "Similarity Blend" to prevent Python memory errors.</span>
                        </div>
                        <div class="bg-black/50 p-4 rounded-xl border border-gray-800 font-mono text-[10px] text-green-400 break-all select-all flex-1 overflow-y-auto" id="exportResult"></div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="copyBtn" onclick="copyToClipboard()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i> Copy String
                    </button>
                    <button onclick="toggleExportModal()" class="px-6 py-3 border border-gray-800 rounded-xl text-gray-400 hover:bg-gray-800 transition">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN HEADER -->
    <header class="h-14 bg-gray-950 border-b border-gray-800 flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <span class="text-red-500 font-black text-2xl italic">VEX</span>
                <span class="text-white font-light text-lg tracking-widest uppercase">Pixel</span>
            </div>
            <button onclick="toggleHelp()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full transition flex items-center gap-2 font-bold shadow-lg shadow-blue-900/20">
                <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> Tips & Info
            </button>
        </div>

        <div class="flex items-center gap-2">
            <label class="cursor-pointer bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2 border border-gray-700">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> Import
                <input type="file" id="imgUpload" class="hidden" accept="image/*" onchange="handleImageImport(event)">
            </label>
            <button onclick="clearCanvasAction()" class="bg-red-950/30 hover:bg-red-600 text-red-500 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition border border-red-900/50 flex items-center gap-2">
                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Clear
            </button>
            <button onclick="exportString(true)" class="bg-green-600 hover:bg-green-500 text-white px-5 py-1.5 rounded-lg text-xs font-black transition shadow-lg flex items-center gap-2">
                <i data-lucide="zap" class="w-3.5 h-3.5"></i> Export
            </button>
        </div>
    </header>

    <main id="canvas-viewport" class="flex-1 relative">
        <canvas id="vexCanvas" width="480" height="240"></canvas>
    </main>

    <!-- FOOTER CONTROLS -->
    <footer class="h-auto bg-gray-950 border-t border-gray-800 flex flex-wrap items-center justify-between px-4 py-2 z-20 gap-4">
        <div class="flex items-center gap-1 bg-[#0a0a0a] p-1 rounded-xl border border-gray-800">
            <button class="tool-btn active" id="tool-brush" onclick="setTool('brush')"><i data-lucide="brush" class="w-5 h-5"></i></button>
            <button class="tool-btn" id="tool-line" onclick="setTool('line')"><i data-lucide="minus" class="w-5 h-5"></i></button>
            <button class="tool-btn" id="tool-bucket" onclick="setTool('bucket')"><i data-lucide="paint-bucket" class="w-5 h-5"></i></button>
            <div class="w-px h-6 bg-gray-800 mx-1"></div>
            <button class="tool-btn" id="tool-pan" onclick="setTool('pan')"><i data-lucide="move" class="w-5 h-5"></i></button>
        </div>

        <div class="flex items-center gap-4 bg-[#0a0a0a] px-4 py-2 rounded-xl border border-gray-800" id="size-container">
            <span class="text-[10px] text-gray-500 font-black uppercase">Size</span>
            <input type="range" id="brushSize" min="1" max="50" value="1" class="w-24 h-1 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-500">
            <span id="brushSizeVal" class="text-xs font-mono text-blue-500 w-4">1</span>
        </div>

        <div class="flex gap-1.5 overflow-x-auto p-1 max-w-[400px] no-scrollbar items-center" id="palette">
            <div class="relative group shrink-0">
                <input type="color" id="colorPickerInput" value="#FF0000" onchange="setCustomColor(this.value)">
                <div class="absolute inset-0 border-2 border-dashed border-gray-600 rounded-md pointer-events-none group-hover:border-blue-500"></div>
            </div>
            <div class="w-px h-6 bg-gray-800 mx-1 shrink-0"></div>
        </div>

        <div class="flex gap-1">
            <button onclick="undo()" class="p-2 text-gray-500 hover:text-white transition"><i data-lucide="undo" class="w-5 h-5"></i></button>
            <button onclick="redo()" class="p-2 text-gray-500 hover:text-white transition"><i data-lucide="redo" class="w-5 h-5"></i></button>
        </div>
    </footer>

<script>
    lucide.createIcons();
    
    const canvas = document.getElementById('vexCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const viewport = document.getElementById('canvas-viewport');
    const cursor = document.getElementById('brush-cursor');
    const previewCanvas = document.getElementById('previewCanvas');
    const previewCtx = previewCanvas.getContext('2d', { willReadFrequently: true });
    const sizeContainer = document.getElementById('size-container');

    const presets = [
        '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', 
        '#FFFF00', '#00FFFF', '#FF00FF', '#FFA500', '#800080', '#808080'
    ];

    let state = {
        tool: 'brush', colorHex: '#FF0000', brushSize: 1, 
        isDrawing: false, lastX: 0, lastY: 0, zoom: 1, panX: 0, panY: 0,
        startDragX: 0, startDragY: 0, isPanning: false, snapshot: null
    };

    const history = [];
    let historyStep = -1;

    const paletteDiv = document.getElementById('palette');
    
    function initPalette() {
        const existing = paletteDiv.querySelectorAll('.color-swatch');
        existing.forEach(e => e.remove());

        presets.forEach(hex => {
            const btn = document.createElement('div');
            btn.className = 'color-swatch shrink-0';
            btn.style.backgroundColor = hex;
            if(hex === state.colorHex) btn.classList.add('active');
            btn.onclick = () => setCustomColor(hex);
            paletteDiv.appendChild(btn);
        });
    }

    function setCustomColor(hex) {
        state.colorHex = hex;
        document.getElementById('colorPickerInput').value = hex;
        document.querySelectorAll('.color-swatch').forEach(b => b.classList.remove('active'));
        const match = Array.from(document.querySelectorAll('.color-swatch')).find(b => {
             return b.style.backgroundColor === hex || rgbToHex(b.style.backgroundColor) === hex.toLowerCase();
        });
        if(match) match.classList.add('active');
    }

    function rgbToHex(rgb) {
        if(!rgb || rgb.startsWith('#')) return rgb;
        const [r,g,b] = rgb.match(/\d+/g);
        return "#" + ((1 << 24) + (+r << 16) + (+g << 8) + +b).toString(16).slice(1);
    }

    initPalette();
    setCustomColor('#FF0000');

    window.handleImageImport = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                saveStep();
                ctx.fillStyle = "#000000";
                ctx.fillRect(0, 0, 480, 240);
                ctx.drawImage(img, 0, 0, 480, 240);
                saveStep();
                event.target.value = ''; 
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    window.setLang = function(lang) {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.lang-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`btn-${lang}`).classList.add('active');
        document.getElementById(`cont-${lang}`).classList.remove('hidden');
    };

    window.toggleHelp = function() {
        document.getElementById('helpModal').classList.toggle('hidden');
    };

    window.toggleExportModal = function() {
        document.getElementById('exportModal').classList.toggle('hidden');
    };

    window.copyToClipboard = function() {
        const text = document.getElementById('exportResult').innerText;
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Copied!';
        btn.classList.replace('bg-blue-600', 'bg-green-600');
        lucide.createIcons();
        setTimeout(() => {
            btn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i> Copy String';
            btn.classList.replace('bg-green-600', 'bg-blue-600');
            lucide.createIcons();
        }, 2000);
    };

    window.updateExportPreview = function() {
        exportString(false);
    };

    window.exportString = function(openModal = true) {
        if(openModal) toggleExportModal();
        const step = parseInt(document.getElementById('stepRange').value);
        const blend = parseInt(document.getElementById('blendRange').value);
        document.getElementById('stepVal').innerText = step + "x";
        document.getElementById('blendVal').innerText = blend + "%";
        const w = 480, h = 240;
        const imgData = ctx.getImageData(0, 0, w, h).data;
        const pData = previewCtx.createImageData(w, h);
        const qFactor = Math.max(1, Math.floor(blend * 2));
        let paletteMap = new Map(); 
        let palette = [];
        let rows = [];
        for(let y = 0; y < h; y += step) {
            let rowIndices = [];
            for(let x = 0; x < w; x += step) {
                const i = (y * w + x) * 4;
                let r = imgData[i], g = imgData[i+1], b = imgData[i+2];
                if (blend > 0) {
                    r = Math.round(r / qFactor) * qFactor;
                    g = Math.round(g / qFactor) * qFactor;
                    b = Math.round(b / qFactor) * qFactor;
                    r=Math.min(255,r); g=Math.min(255,g); b=Math.min(255,b);
                }
                for(let dy=0; dy<step; dy++){
                    for(let dx=0; dx<step; dx++){
                        if(y+dy<h && x+dx<w) {
                            const pi = ((y+dy)*w + (x+dx))*4;
                            pData.data[pi] = r; pData.data[pi+1] = g; pData.data[pi+2] = b; pData.data[pi+3] = 255;
                        }
                    }
                }
                const key = `${r},${g},${b}`;
                if(!paletteMap.has(key)) {
                    paletteMap.set(key, palette.length);
                    const hex = ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                    palette.push(hex);
                }
                rowIndices.push(paletteMap.get(key));
            }
            let rleStr = "";
            let current = rowIndices[0], count = 1;
            for(let k=1; k<rowIndices.length; k++) {
                if(rowIndices[k] === current) count++;
                else {
                    rleStr += `${current.toString(36)}.${count.toString(36)},`;
                    current = rowIndices[k]; count = 1;
                }
            }
            rleStr += `${current.toString(36)}.${count.toString(36)}`;
            rows.push(rleStr);
        }
        previewCtx.putImageData(pData, 0, 0);
        const result = `${step}|${palette.join(',')} |${rows.join(';')}`;
        document.getElementById('exportResult').innerText = result;
        const len = result.length;
        document.getElementById('charCount').innerText = `${len.toLocaleString()} Chars`;
        if(len > 50000) document.getElementById('memoryWarning').classList.remove('hidden');
        else document.getElementById('memoryWarning').classList.add('hidden');
    };

    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: Math.floor((e.clientX - rect.left) * (480 / rect.width)),
            y: Math.floor((e.clientY - rect.top) * (240 / rect.height))
        };
    }

    document.getElementById('brushSize').addEventListener('input', (e) => {
        state.brushSize = parseInt(e.target.value);
        document.getElementById('brushSizeVal').innerText = state.brushSize;
    });

    document.addEventListener('mousemove', (e) => {
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
        const isOverCanvas = viewport.contains(e.target);
        const isOverSlider = sizeContainer.contains(e.target);
        if ((isOverCanvas && state.tool !== 'pan') || isOverSlider) {
            cursor.style.display = 'block';
            viewport.style.cursor = 'none';
            let d = isOverSlider ? state.brushSize * 2 : state.brushSize * state.zoom;
            cursor.style.width = `${d}px`; cursor.style.height = `${d}px`;
        } else {
            cursor.style.display = 'none';
            viewport.style.cursor = state.tool === 'pan' ? 'grab' : 'default';
        }
    });

    function setTool(t) {
        state.tool = t;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tool-${t}`).classList.add('active');
    }

    ctx.fillStyle = '#000000';
    ctx.fillRect(0,0,480,240);
    saveStep();

    function saveStep() {
        if(historyStep < history.length - 1) history.length = historyStep + 1;
        history.push(ctx.getImageData(0,0,480,240));
        if(history.length > 50) history.shift(); else historyStep++;
    }

    function undo() { if(historyStep > 0) ctx.putImageData(history[--historyStep], 0, 0); }
    function redo() { if(historyStep < history.length - 1) ctx.putImageData(history[++historyStep], 0, 0); }

    viewport.addEventListener('mousedown', (e) => {
        if(e.button === 1 || state.tool === 'pan') {
            state.isPanning = true;
            state.startDragX = e.clientX; state.startDragY = e.clientY;
            return;
        }
        const {x, y} = getCoords(e);
        state.isDrawing = true;
        state.lastX = x; state.lastY = y;
        state.startDragX = x; state.startDragY = y;
        if(state.tool === 'line') state.snapshot = ctx.getImageData(0,0,480,240);
        else if(state.tool === 'brush') plot(x, y);
        else if(state.tool === 'bucket') {
            saveStep(); floodFill(x, y, state.colorHex); state.isDrawing = false;
        }
    });

    window.addEventListener('mousemove', (e) => {
        if(state.isPanning) {
            state.panX += e.clientX - state.startDragX; state.panY += e.clientY - state.startDragY;
            state.startDragX = e.clientX; state.startDragY = e.clientY;
            updateTransform(); return;
        }
        if(!state.isDrawing) return;
        const {x, y} = getCoords(e);
        if(state.tool === 'brush') { line(state.lastX, state.lastY, x, y); state.lastX = x; state.lastY = y; }
        else if(state.tool === 'line') { ctx.putImageData(state.snapshot, 0, 0); line(state.startDragX, state.startDragY, x, y); }
    });

    window.addEventListener('mouseup', () => {
        if(state.isDrawing) { state.isDrawing = false; saveStep(); }
        state.isPanning = false;
    });

    function updateTransform() {
        canvas.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
    }

    function plot(x, y) {
        ctx.fillStyle = state.colorHex;
        const r = state.brushSize / 2;
        if(state.brushSize === 1) ctx.fillRect(x, y, 1, 1);
        else { ctx.beginPath(); ctx.arc(x + 0.5, y + 0.5, r, 0, Math.PI * 2); ctx.fill(); }
    }

    function line(x0, y0, x1, y1) {
        const dx = Math.abs(x1 - x0), dy = Math.abs(y1 - y0);
        const sx = x0 < x1 ? 1 : -1, sy = y0 < y1 ? 1 : -1;
        let err = dx - dy;
        while(true) {
            plot(x0, y0);
            if(x0 === x1 && y0 === y1) break;
            const e2 = 2 * err;
            if(e2 > -dy) { err -= dy; x0 += sx; }
            if(e2 < dx) { err += dx; y0 += sy; }
        }
    }

    function floodFill(startX, startY, fillHex) {
        const img = ctx.getImageData(0,0,480,240);
        const data = img.data;
        const i = (startY * 480 + startX) * 4;
        const tr = data[i], tg = data[i+1], tb = data[i+2];
        const f = hexToR(fillHex);
        if(tr === f.r && tg === f.g && tb === f.b) return;
        const q = [[startX, startY]];
        while(q.length) {
            const [x, y] = q.pop();
            if(x<0||x>=480||y<0||y>=240) continue;
            const idx = (y*480+x)*4;
            if(data[idx]===tr && data[idx+1]===tg && data[idx+2]===tb) {
                data[idx]=f.r; data[idx+1]=f.g; data[idx+2]=f.b; data[idx+3]=255;
                q.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
            }
        }
        ctx.putImageData(img, 0, 0);
    }

    function hexToR(h) {
        const b = parseInt(h.slice(1),16);
        return { r:(b>>16)&255, g:(b>>8)&255, b:b&255 };
    }

    window.clearCanvasAction = function() {
        if(confirm("Wipe everything to black?")) {
            ctx.fillStyle = '#000000'; ctx.fillRect(0,0,480,240); saveStep();
        }
    };

    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        state.zoom *= (e.deltaY > 0 ? 0.9 : 1.1);
        state.zoom = Math.min(Math.max(0.1, state.zoom), 30);
        updateTransform();
    });

    window.addEventListener('keydown', (e) => {
        if(e.key === '1') setTool('brush');
        if(e.key === '2') setTool('line');
        if(e.key === '3') setTool('bucket');
        if(e.key === '4') setTool('pan');
        if(e.ctrlKey && e.key === 'z') undo();
        if(e.ctrlKey && e.key === 'y') redo();
    });

    window.onload = () => {
        state.zoom = Math.min((viewport.clientWidth-40)/480, (viewport.clientHeight-40)/240);
        updateTransform();
    };
</script>
</body>
</html>